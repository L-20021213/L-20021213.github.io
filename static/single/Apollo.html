
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apollo - 全参数动态闪光灯曝光计算器</title>
    <link rel="icon" type="image/ico" href="https://cdn.siax.cn/npm/picture-sianx@1.1.2/img/6945257127.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.siax.cn/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#165DFF',
                        secondary: '#64748B',
                        success: '#10B981',
                        warning: '#F59E0B',
                        danger: '#EF4444',
                        neutral: '#F1F5F9',
                        dark: '#1E293B',
                    },
                    fontFamily: {
                        inter: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .input-focus {
                @apply focus:border-primary focus:ring-2 focus:ring-primary/20 focus:outline-none;
            }
            .card-shadow {
                @apply shadow-lg shadow-gray-100/80;
            }
            .transition-all-300 {
                @apply transition-all duration-300 ease-in-out;
            }
            .status-border-success {
                @apply border-success ring-2 ring-success/20;
            }
            .status-border-warning {
                @apply border-warning ring-2 ring-warning/20;
            }
            .status-border-danger {
                @apply border-danger ring-2 ring-danger/20;
            }
            .recently-updated {
                @apply border-primary animate-pulse;
            }
            .param-pill {
                @apply bg-white px-4 py-2 rounded-lg border border-gray-200 shadow-sm flex items-center gap-2;
            }
            .input-warning {
                @apply border-warning focus:border-warning focus:ring-warning/20;
            }
            .param-prefix {
                @apply font-bold text-gray-500;
            }
            
            /* 双按钮 Pill 样式 */
            .pill-toggle {
                @apply inline-flex rounded-full overflow-hidden border border-gray-200;
            }
            .pill-button {
                @apply px-4 py-1.5 text-sm font-medium transition-all duration-200 ease-in-out cursor-pointer;
            }
            .pill-button:first-child {
                @apply rounded-l-full;
            }
            .pill-button:last-child {
                @apply rounded-r-full;
            }
            .pill-button:not(.active) {
                @apply bg-white text-gray-600 hover:bg-gray-50;
            }
            .pill-button.active {
                @apply bg-primary text-white hover:bg-primary/90;
            }
            .pill-button:focus {
                @apply outline-none ring-2 ring-primary/30;
            }
            
            /* 输入框和按钮动画 */
            .form-group input {
                @apply transition-all duration-200 ease-in-out;
            }
            .form-group input:hover:not(:focus) {
                @apply border-gray-400;
            }
            .btn-hover-effect {
                @apply transform hover:scale-[1.02] active:scale-[0.98] transition-all duration-200;
            }
            
            /* 参数范围提示样式 */
            .param-range-section {
                @apply mt-8 p-5 bg-gray-50 rounded-xl border border-gray-200;
            }
            .range-table {
                @apply w-full text-sm;
            }
            .range-table th {
                @apply py-3 px-2 text-left text-gray-700 font-semibold;
            }
            .range-table td {
                @apply py-2 px-2 text-gray-600 border-t border-gray-100;
            }
            .range-table tr:hover td {
                @apply bg-gray-50;
            }
        }
    </style>
</head>
<body class="bg-gray-50 font-inter text-dark min-h-screen">
    <div class="max-w-2xl mx-auto px-4 py-8">
        <div class="bg-white rounded-xl p-6 md:p-8 card-shadow transition-all duration-300 hover:shadow-xl">
            <div class="text-center mb-8">
                <h1 class="text-[clamp(1.5rem,3vw,2.25rem)] font-bold text-dark mb-2">
                    <i class="fa fa-sun-o text-warning mr-2"></i>Apollo
                    <span class="block text-[clamp(1rem,2vw,1.5rem)] mt-1">全参数动态闪光灯曝光计算器</span>
                </h1>
                <p class="text-gray-500">调整任何参数，其他参数将实时自动优化</p>
            </div>
            
            <div class="mb-6 p-4 bg-primary/5 rounded-lg border border-primary/10">
                <p class="text-sm text-primary flex items-center">
                    <i class="fa fa-info-circle mr-2"></i>
                    所有参数均可直接调整，系统会自动保持曝光平衡，最近调整的参数会高亮显示
                </p>
            </div>
            
            <div class="space-y-6">
                <!-- 基础参数区域 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 闪光指数 -->
                    <div class="form-group relative">
                        <label for="gn" class="block text-sm font-medium text-gray-700 mb-1.5">
                            闪光指数（GN值）
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-lightbulb-o"></i>
                            </span>
                            <input 
                                type="number" 
                                id="gn" 
                                min="1" 
                                max="100" 
                                step="0.1" 
                                value="12" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：12.5"
                            >
                        </div>
                        <p class="text-xs text-gray-500 mt-1">常用范围：10-60，支持一位小数</p>
                    </div>

                    <!-- 闪光灯功率 -->
                    <div class="form-group relative">
                        <label for="power" class="block text-sm font-medium text-gray-700 mb-1.5">
                            闪光灯灯功率（%）
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-tachometer"></i>
                            </span>
                            <input 
                                type="number" 
                                id="power" 
                                min="1" 
                                max="100" 
                                step="1" 
                                value="100" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：50"
                            >
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
                                %
                            </span>
                        </div>
                        <div id="powerWarning" class="text-xs text-warning mt-1 hidden">
                            <i class="fa fa-exclamation-circle"></i> 功率范围仅限1-100%，已自动修正
                        </div>
                    </div>

                    <!-- 拍摄距离 -->
                    <div class="form-group relative">
                        <label for="distance" class="block text-sm font-medium text-gray-700 mb-1.5">
                            拍摄距离（米）
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-arrows-h"></i>
                            </span>
                            <input 
                                type="number" 
                                id="distance" 
                                min="0.1" 
                                max="20" 
                                step="0.1" 
                                value="2" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：3.5"
                            >
                            <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500">
                                m
                            </span>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">常用范围：0.5-10米，支持一位小数</p>
                    </div>

                    <!-- ISO值 -->
                    <div class="form-group relative">
                        <label for="iso" class="block text-sm font-medium text-gray-700 mb-1.5">
                            ISO值
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3">
                                <span class="param-prefix">ISO</span>
                            </span>
                            <input 
                                type="number" 
                                id="iso" 
                                min="100" 
                                max="6400" 
                                step="100" 
                                value="100" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：400"
                            >
                        </div>
                        <p class="text-xs text-gray-500 mt-1">建议范围：100-3200，步进100</p>
                    </div>

                    <!-- 快门速度 -->
                    <div class="form-group relative">
                        <label for="shutter" class="block text-sm font-medium text-gray-700 mb-1.5">
                            快门速度
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-clock-o"></i>
                            </span>
                            <input 
                                type="number" 
                                id="shutter" 
                                min="1" 
                                max="30000" 
                                step="1" 
                                value="250" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：250"
                            >
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3">
                                <!-- 双按钮 Pill 样式切换 -->
                                <div class="pill-toggle" role="group" aria-label="快门模式选择">
                                    <button 
                                        id="shutterFractionBtn" 
                                        class="pill-button active" 
                                        aria-pressed="true"
                                    >
                                        1/x秒
                                    </button>
                                    <button 
                                        id="shutterSecondBtn" 
                                        class="pill-button" 
                                        aria-pressed="false"
                                    >
                                        x秒
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div id="syncWarning" class="text-xs text-danger mt-1 hidden">
                            <i class="fa fa-exclamation-triangle"></i> 超过多数相机同步速度（1/250s）
                        </div>
                        <div id="tripodWarning" class="text-xs text-warning mt-1 hidden">
                            <i class="fa fa-camera"></i> 建议使用三脚架（慢于1/30s）
                        </div>
                    </div>

                    <!-- 光圈值 -->
                    <div class="form-group relative">
                        <label for="aperture" class="block text-sm font-medium text-gray-700 mb-1.5">
                            光圈值（f/）
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-circle-o"></i>
                            </span>
                            <input 
                                type="number" 
                                id="aperture" 
                                min="0.7" 
                                max="32" 
                                step="0.1" 
                                value="2.8" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：2.8"
                            >
                        </div>
                        <p class="text-xs text-gray-500 mt-1">支持一位小数，常用范围：f/1.8-f/16</p>
                    </div>
                </div>
                
                <!-- 光圈范围设置 -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- 最小光圈 -->
                    <div class="form-group">
                        <label for="minAperture" class="block text-sm font-medium text-gray-700 mb-1.5">
                            最小光圈限制（f/）
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-compress"></i>
                            </span>
                            <input 
                                type="number" 
                                id="minAperture" 
                                min="0.7" 
                                max="32" 
                                step="0.1" 
                                value="1.8" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：1.8"
                            >
                        </div>
                        <p class="text-xs text-gray-500 mt-1">镜头最大光圈（数值越小光圈越大）</p>
                    </div>
                    
                    <!-- 最大光圈 -->
                    <div class="form-group">
                        <label for="maxAperture" class="block text-sm font-medium text-gray-700 mb-1.5">
                            最大光圈限制（f/）
                        </label>
                        <div class="relative">
                            <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500">
                                <i class="fa fa-expand"></i>
                            </span>
                            <input 
                                type="number" 
                                id="maxAperture" 
                                min="0.7" 
                                max="32" 
                                step="0.1" 
                                value="16" 
                                class="w-full pl-10 pr-3 py-3 border border-gray-300 rounded-lg input-focus"
                                placeholder="例如：16"
                            >
                        </div>
                        <p class="text-xs text-gray-500 mt-1">镜头最小光圈（数值越大光圈越小）</p>
                    </div>
                </div>
                
                <!-- 重置按钮 -->
                <button 
                    id="resetBtn"
                    class="w-full bg-gray-200 hover:bg-gray-300 text-dark font-medium py-3 px-4 rounded-lg transition-all-300 flex items-center justify-center gap-2 btn-hover-effect"
                >
                    <i class="fa fa-refresh"></i>
                    <span>重置所有参数</span>
                </button>
                
                <!-- 结果显示区域 -->
                <div class="result bg-neutral rounded-xl p-6 text-center transition-all-300 hover:shadow-md">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4">Apollo 曝光状态</h2>
                    <div id="exposureStatus" class="text-[clamp(1.5rem,4vw,2.5rem)] font-bold text-success">
                        曝光平衡
                    </div>
                    
                    <!-- 当前关键参数总结 -->
                    <div class="flex flex-wrap justify-center gap-3 my-4">
                        <div class="param-pill">
                            <i class="fa fa-circle-o text-primary"></i>
                            <span><strong>光圈：</strong><span id="currentApertureDisplay">f/2.8</span></span>
                        </div>
                        <div class="param-pill">
                            <i class="fa fa-clock-o text-primary"></i>
                            <span><strong>快门：</strong><span id="currentShutterDisplay">1/250s</span></span>
                        </div>
                        <div class="param-pill">
                            <span class="param-prefix text-primary">ISO</span>
                            <span><strong>：</strong><span id="currentIsoDisplay">100</span></span>
                        </div>
                        <div class="param-pill">
                            <i class="fa fa-arrows-h text-primary"></i>
                            <span><strong>距离：</strong><span id="currentDistanceDisplay">2.0米</span></span>
                        </div>
                        <div class="param-pill">
                            <i class="fa fa-tachometer text-primary"></i>
                            <span><strong>功率：</strong><span id="currentPowerDisplay">100%</span></span>
                        </div>
                    </div>
                    
                    <div id="exposureDetails" class="text-sm text-gray-600 mt-2">
                        所有参数已优化至平衡状态
                    </div>
                </div>
                
                <!-- 参数说明区域 -->
                <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                    <h3 class="font-medium text-primary mb-2 flex items-center">
                        <i class="fa fa-info-circle mr-2"></i>Apollo 动态调整说明
                    </h3>
                    <p class="text-sm text-gray-600">
                        曝光公式：光圈 = 闪光指数 × 功率系数 ÷ 距离 × √(ISO/100) × √(基准快门/实际快门)
                    </p>
                    <p class="text-xs text-gray-500 mt-1">
                        调整任一参数时，系统会优先调整对画面影响较小的参数（功率 > ISO > 距离 > 快门 > 光圈）
                    </p>
                </div>
                
                <!-- 参数参考范围汇总 -->
                <div class="param-range-section">
                    <h3 class="font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fa fa-book text-primary mr-2"></i>Apollo 参数参考范围汇总
                    </h3>
                    <table class="range-table">
                        <thead>
                            <tr>
                                <th>参数类型</th>
                                <th>应用场景</th>
                                <th>推荐范围</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- 闪光指数 -->
                            <tr>
                                <td rowspan="3" class="font-medium">闪光指数</td>
                                <td>小型闪光灯</td>
                                <td>10-30</td>
                            </tr>
                            <tr>
                                <td>中型闪光灯</td>
                                <td>30-50</td>
                            </tr>
                            <tr>
                                <td>大型影室灯</td>
                                <td>50-100</td>
                            </tr>
                            
                            <!-- 闪光灯功率 -->
                            <tr>
                                <td rowspan="3" class="font-medium">闪光灯功率</td>
                                <td>近距离补光</td>
                                <td>1-25%</td>
                            </tr>
                            <tr>
                                <td>常规拍摄</td>
                                <td>25-75%</td>
                            </tr>
                            <tr>
                                <td>远距离/强光</td>
                                <td>75-100%</td>
                            </tr>
                            
                            <!-- 拍摄距离 -->
                            <tr>
                                <td rowspan="3" class="font-medium">拍摄距离</td>
                                <td>微距/特写</td>
                                <td>0.5-1.5m</td>
                            </tr>
                            <tr>
                                <td>人像/产品</td>
                                <td>1.5-5m</td>
                            </tr>
                            <tr>
                                <td>群体/环境</td>
                                <td>5-10m</td>
                            </tr>
                            
                            <!-- ISO值 -->
                            <tr>
                                <td rowspan="3" class="font-medium">ISO值</td>
                                <td>低噪点/静态</td>
                                <td>100-400</td>
                            </tr>
                            <tr>
                                <td>常规拍摄</td>
                                <td>400-800</td>
                            </tr>
                            <tr>
                                <td>低光/动态</td>
                                <td>800-3200</td>
                            </tr>
                            
                            <!-- 快门速度 -->
                            <tr>
                                <td rowspan="3" class="font-medium">快门速度</td>
                                <td>高速同步</td>
                                <td>1/1000s以上</td>
                            </tr>
                            <tr>
                                <td>常规同步</td>
                                <td>1/125-1/250s</td>
                            </tr>
                            <tr>
                                <td>慢速同步</td>
                                <td>1/60s以下</td>
                            </tr>
                            
                            <!-- 光圈值 -->
                            <tr>
                                <td rowspan="3" class="font-medium">光圈值</td>
                                <td>浅景深/弱光</td>
                                <td>f/1.8-f/4</td>
                            </tr>
                            <tr>
                                <td>常规拍摄</td>
                                <td>f/4-f/8</td>
                            </tr>
                            <tr>
                                <td>大景深/强光</td>
                                <td>f/8-f/16</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <footer class="text-center text-gray-500 text-sm mt-6">
            <p>Apollo 闪光灯曝光计算器 | 摄影辅助工具</p>
        </footer>
    </div>

    <script>
        // 相机常见光圈档位
        const commonApertures = [
            0.7, 0.8, 1, 1.2, 1.4, 1.6, 1.8, 2, 2.2, 2.5, 2.8, 
            3.2, 3.5, 4, 4.5, 5, 5.6, 6.3, 7.1, 8, 9, 10, 11, 
            13, 14, 16, 18, 20, 22, 25, 29, 32
        ];
        
        // 快门模式：fraction(1/x秒) 或 second(x秒)
        let shutterMode = 'fraction'; // 默认1/x秒模式
        // 典型闪光灯同步速度 (秒)
        const typicalSyncSpeed = 0.004; // 1/250s
        // 安全快门速度 (秒)
        const safeShutterSpeed = 0.033; // 约1/30s
        // 防止循环计算的标志
        let isCalculating = false;
        // 记录最近更新的参数
        let lastUpdatedParam = null;
        // 跟踪是否正在输入中
        let isTyping = false;
        // 防抖计时器
        let calculationDebounceTimer = null;

        // 获取DOM元素
        const gnInput = document.getElementById('gn');
        const powerInput = document.getElementById('power');
        const distanceInput = document.getElementById('distance');
        const isoInput = document.getElementById('iso');
        const shutterInput = document.getElementById('shutter');
        const apertureInput = document.getElementById('aperture');
        const minApertureInput = document.getElementById('minAperture');
        const maxApertureInput = document.getElementById('maxAperture');
        const resetBtn = document.getElementById('resetBtn');
        const syncWarning = document.getElementById('syncWarning');
        const tripodWarning = document.getElementById('tripodWarning');
        const powerWarning = document.getElementById('powerWarning');
        const exposureStatus = document.getElementById('exposureStatus');
        const exposureDetails = document.getElementById('exposureDetails');
        const resultContainer = document.querySelector('.result');
        const allInputs = [gnInput, powerInput, distanceInput, isoInput, shutterInput, apertureInput];
        
        // 双按钮切换相关元素
        const shutterFractionBtn = document.getElementById('shutterFractionBtn');
        const shutterSecondBtn = document.getElementById('shutterSecondBtn');
        
        // 关键参数显示元素
        const currentApertureDisplay = document.getElementById('currentApertureDisplay');
        const currentShutterDisplay = document.getElementById('currentShutterDisplay');
        const currentIsoDisplay = document.getElementById('currentIsoDisplay');
        const currentDistanceDisplay = document.getElementById('currentDistanceDisplay');
        const currentPowerDisplay = document.getElementById('currentPowerDisplay');

        // 格式化快门显示文本
        function formatShutterSpeed(value, mode) {
            if (mode === 'second') {
                return `${value}s`;
            } else {
                return `1/${value}s`;
            }
        }

        // 转换快门值为秒（用于计算）
        function getShutterInSeconds(value, mode) {
            if (mode === 'second') {
                return parseFloat(value);
            } else {
                return 1 / parseFloat(value);
            }
        }

        // 切换快门模式
        function toggleShutterMode(newMode) {
            // 如果点击已激活的按钮，不执行任何操作
            if (newMode === shutterMode) return;
            
            // 更新按钮状态
            if (newMode === 'fraction') {
                shutterFractionBtn.classList.add('active');
                shutterFractionBtn.setAttribute('aria-pressed', 'true');
                shutterSecondBtn.classList.remove('active');
                shutterSecondBtn.setAttribute('aria-pressed', 'false');
            } else {
                shutterSecondBtn.classList.add('active');
                shutterSecondBtn.setAttribute('aria-pressed', 'true');
                shutterFractionBtn.classList.remove('active');
                shutterFractionBtn.setAttribute('aria-pressed', 'false');
            }
            
            // 添加点击反馈动画
            const activeBtn = newMode === 'fraction' ? shutterFractionBtn : shutterSecondBtn;
            activeBtn.classList.add('scale-105');
            setTimeout(() => {
                activeBtn.classList.remove('scale-105');
            }, 200);
            
            // 模式切换逻辑
            const currentValue = parseFloat(shutterInput.value) || 1;
            
            // 计算新模式下的等值
            let newValue;
            if (newMode === 'second' && shutterMode === 'fraction') {
                // 从1/x秒转换为x秒
                newValue = 1 / currentValue;
                newValue = newValue < 1 ? Math.round(newValue * 10000) / 10000 : Math.round(newValue * 10) / 10;
            } else {
                // 从x秒转换为1/x秒
                newValue = 1 / currentValue;
                newValue = Math.min(Math.round(newValue), 30000);
            }
            
            // 更新模式和值
            shutterMode = newMode;
            shutterInput.value = newValue;
            
            // 重新计算
            calculateExposure('shutter');
        }

        // 验证并修正参数范围
        function validateAndFixParams(skipFix = false) {
            let powerWarningShown = false;
            
            // 修正闪光指数（1-100）
            let gn = parseFloat(gnInput.value) || 1;
            gn = Math.max(1, Math.min(100, gn));
            if (!skipFix) gnInput.value = gn.toFixed(1);
            
            // 修正闪光灯功率（1-100%）
            let power = parseInt(powerInput.value) || 1;
            if (power < 1 || power > 100) {
                power = Math.max(1, Math.min(100, power));
                if (!skipFix) powerInput.value = power;
                powerWarning.classList.remove('hidden');
                powerWarningShown = true;
                powerInput.classList.add('input-warning');
            } else {
                powerWarning.classList.add('hidden');
                powerInput.classList.remove('input-warning');
            }
            
            // 修正拍摄距离（0.1-20米）
            let distance = parseFloat(distanceInput.value) || 0.1;
            distance = Math.max(0.1, Math.min(20, distance));
            if (!skipFix) distanceInput.value = distance.toFixed(1);
            
            // 修正ISO值（100-6400，步进100）
            let iso = parseInt(isoInput.value) || 100;
            iso = Math.max(100, Math.min(6400, iso));
            iso = Math.round(iso / 100) * 100; // 确保是100的倍数
            if (!skipFix) isoInput.value = iso;
            
            // 修正快门速度
            let shutter = parseFloat(shutterInput.value) || 250;
            if (shutterMode === 'fraction') {
                // 1/x秒模式：1-30000
                shutter = Math.max(1, Math.min(30000, shutter));
                if (!skipFix) shutterInput.value = Math.round(shutter);
            } else {
                // x秒模式：0.1-30
                shutter = Math.max(0.1, Math.min(30, shutter));
                if (!skipFix) shutterInput.value = shutter.toFixed(1);
            }
            
            // 修正光圈值（0.7-32）
            let aperture = parseFloat(apertureInput.value) || 2.8;
            aperture = Math.max(0.7, Math.min(32, aperture));
            if (!skipFix) apertureInput.value = aperture.toFixed(1);
            
            // 修正光圈范围
            let minAperture = parseFloat(minApertureInput.value) || 1.8;
            let maxAperture = parseFloat(maxApertureInput.value) || 16;
            minAperture = Math.max(0.7, Math.min(32, minAperture));
            maxAperture = Math.max(0.7, Math.min(32, maxAperture));
            // 确保最小光圈小于最大光圈
            if (minAperture >= maxAperture) {
                maxAperture = minAperture + 1;
                if (!skipFix) maxApertureInput.value = maxAperture.toFixed(1);
            }
            if (!skipFix) {
                minApertureInput.value = minAperture.toFixed(1);
                maxApertureInput.value = maxAperture.toFixed(1);
            }
            
            return { powerWarningShown };
        }
        
        // 检查快门同步和三脚架提示
        function checkShutterConditions() {
            const shutterValue = parseFloat(shutterInput.value);
            const shutterSeconds = getShutterInSeconds(shutterValue, shutterMode);
            
            let syncOk = true;
            let tripodNeeded = false;
            
            // 检查是否超过同步速度（快门过快）
            if (shutterSeconds < typicalSyncSpeed) {
                shutterInput.classList.add('status-border-danger');
                syncWarning.classList.remove('hidden');
                syncOk = false;
            } else {
                shutterInput.classList.remove('status-border-danger');
                syncWarning.classList.add('hidden');
            }
            
            // 检查是否需要三脚架（快门过慢）
            if (shutterSeconds > safeShutterSpeed) {
                shutterInput.classList.add('status-border-warning');
                tripodWarning.classList.remove('hidden');
                tripodNeeded = true;
            } else {
                shutterInput.classList.remove('status-border-warning');
                tripodWarning.classList.add('hidden');
            }
            
            return { syncOk, tripodNeeded, shutterSeconds };
        }

        // 获取最接近的常见光圈值
        function getClosestAperture(value) {
            return commonApertures.reduce((prev, curr) => {
                return Math.abs(curr - value) < Math.abs(prev - value) ? curr : prev;
            });
        }

        // 限制光圈在范围内
        function constrainAperture(value) {
            const min = parseFloat(minApertureInput.value) || 1.8;
            const max = parseFloat(maxApertureInput.value) || 16;
            return Math.max(min, Math.min(max, value));
        }

        // 移除所有输入框的高亮状态
        function clearHighlights() {
            allInputs.forEach(input => {
                input.classList.remove('recently-updated');
            });
        }

        // 高亮显示最近更新的参数
        function highlightUpdatedParam(paramId) {
            clearHighlights();
            const input = document.getElementById(paramId);
            if (input) {
                input.classList.add('recently-updated');
                // 3秒后移除高亮
                setTimeout(() => {
                    input.classList.remove('recently-updated');
                }, 3000);
            }
        }

        // 更新关键参数显示
        function updateKeyParamsDisplay(aperture, shutter, iso, distance, power) {
            currentApertureDisplay.textContent = `f/${aperture.toFixed(1)}`;
            currentShutterDisplay.textContent = formatShutterSpeed(shutter, shutterMode);
            currentIsoDisplay.textContent = iso;
            currentDistanceDisplay.textContent = `${distance.toFixed(1)}米`;
            currentPowerDisplay.textContent = `${power}%`;
        }

        // 计算曝光参数
        function calculateExposure(sourceParam, skipFix = false) {
            // 防止循环计算
            if (isCalculating) return;
            isCalculating = true;
            
            // 验证并修正所有参数范围
            const { powerWarningShown } = validateAndFixParams(skipFix);
            
            // 记录最近更新的参数
            if (sourceParam) {
                lastUpdatedParam = sourceParam;
                highlightUpdatedParam(sourceParam);
            }

            // 获取当前参数值（已确保在有效范围内）
            let gn = parseFloat(gnInput.value);
            let power = parseFloat(powerInput.value) / 100;
            let distance = parseFloat(distanceInput.value);
            let iso = parseInt(isoInput.value);
            let shutterValue = parseFloat(shutterInput.value);
            let aperture = parseFloat(apertureInput.value);
            const minAperture = parseFloat(minApertureInput.value);
            const maxAperture = parseFloat(maxApertureInput.value);
            
            // 获取快门的秒数表示（用于计算）
            const shutterSeconds = getShutterInSeconds(shutterValue, shutterMode);

            // 计算曝光系数
            const isoFactor = Math.sqrt(iso / 100);
            const baseShutter = 0.01; // 基准快门1/100s
            const shutterFactor = Math.sqrt(baseShutter / shutterSeconds);
            const baseAperture = (gn * power * isoFactor * shutterFactor) / distance;
            
            // 如果正在输入中，不进行参数调整
            if (!isTyping) {
                // 根据不同的源参数，采用不同的调整策略
                switch (sourceParam) {
                    case 'gn':
                    case 'distance':
                        // 调整闪光指数或距离时，优先调整功率
                        power = (aperture * distance) / (gn * isoFactor * shutterFactor);
                        power = Math.min(1, Math.max(0.01, power)); // 限制在1%-100%
                        powerInput.value = Math.round(power * 100);
                        break;
                        
                    case 'iso':
                    case 'shutter':
                        // 调整ISO或快门时，优先调整功率，功率超出范围则调整光圈
                        power = (aperture * distance) / (gn * isoFactor * shutterFactor);
                        if (power < 0.01 || power > 1) {
                            power = Math.min(1, Math.max(0.01, power));
                            aperture = (gn * power * isoFactor * shutterFactor) / distance;
                            aperture = getClosestAperture(constrainAperture(aperture));
                            apertureInput.value = aperture.toFixed(1);
                        }
                        powerInput.value = Math.round(power * 100);
                        break;
                        
                    case 'aperture':
                        // 调整光圈时，优先调整功率
                        power = (aperture * distance) / (gn * isoFactor * shutterFactor);
                        power = Math.min(1, Math.max(0.01, power));
                        powerInput.value = Math.round(power * 100);
                        break;
                        
                    case 'power':
                        // 调整功率时，调整光圈
                        aperture = baseAperture;
                        aperture = getClosestAperture(constrainAperture(aperture));
                        apertureInput.value = aperture.toFixed(1);
                        break;
                        
                    case 'minAperture':
                    case 'maxAperture':
                        // 调整光圈范围时，确保当前光圈在范围内
                        aperture = getClosestAperture(constrainAperture(baseAperture));
                        apertureInput.value = aperture.toFixed(1);
                        power = (aperture * distance) / (gn * isoFactor * shutterFactor);
                        power = Math.min(1, Math.max(0.01, power));
                        powerInput.value = Math.round(power * 100);
                        break;
                }

                // 再次验证参数（确保计算后仍在有效范围）
                if (!skipFix) {
                    validateAndFixParams();
                    // 重新获取可能被修正的参数值
                    shutterValue = parseFloat(shutterInput.value);
                    power = parseInt(powerInput.value);
                    aperture = parseFloat(apertureInput.value);
                }
            }
            
            // 检查快门同步和三脚架需求
            const { syncOk, tripodNeeded } = checkShutterConditions();

            // 更新关键参数显示
            updateKeyParamsDisplay(aperture, shutterValue, iso, distance, power);

            // 更新状态显示
            exposureStatus.textContent = '曝光平衡';
            exposureStatus.className = 'text-[clamp(1.5rem,4vw,2.5rem)] font-bold text-success';
            
            // 构建状态详情
            let details = sourceParam ? `基于${getParamDisplayName(sourceParam)}的调整已优化其他参数` : '所有参数已优化至平衡状态';
            if (power < 5) {
                details += ' - 注意：闪光灯功率过低，可能影响曝光稳定性';
            } else if (power > 95) {
                details += ' - 注意：闪光灯已使用最大功率，建议增加距离或减小光圈';
            }
            if (!syncOk) {
                details += ' - 注意：超过标准同步速度，可能导致黑边';
            }
            if (tripodNeeded) {
                details += ' - 提示：使用三脚架避免手抖模糊';
            }
            if (powerWarningShown) {
                details += ' - 已自动修正超出范围的功率值';
            }
            exposureDetails.textContent = details;

            // 添加结果动画效果
            if (!isTyping) {
                resultContainer.classList.add('scale-105', 'shadow-md');
                setTimeout(() => {
                    resultContainer.classList.remove('scale-105', 'shadow-md');
                }, 300);
            }

            isCalculating = false;
        }

        // 获取参数显示名称
        function getParamDisplayName(paramId) {
            const names = {
                'gn': '闪光指数',
                'power': '闪光灯功率',
                'distance': '拍摄距离',
                'iso': 'ISO值',
                'shutter': '快门速度',
                'aperture': '光圈值',
                'minAperture': '最小光圈',
                'maxAperture': '最大光圈'
            };
            return names[paramId] || paramId;
        }

        // 重置参数
        function resetParameters() {
            // 清除所有计时器
            if (calculationDebounceTimer) {
                clearTimeout(calculationDebounceTimer);
                calculationDebounceTimer = null;
            }
            
            // 重置为默认值
            gnInput.value = 12;
            powerInput.value = 100;
            distanceInput.value = 2;
            isoInput.value = 100;
            shutterInput.value = 250;
            apertureInput.value = 2.8;
            minApertureInput.value = 1.8;
            maxApertureInput.value = 16;
            
            // 重置快门模式
            shutterMode = 'fraction';
            shutterFractionBtn.classList.add('active');
            shutterFractionBtn.setAttribute('aria-pressed', 'true');
            shutterSecondBtn.classList.remove('active');
            shutterSecondBtn.setAttribute('aria-pressed', 'false');
            
            // 清除警告和高亮
            powerWarning.classList.add('hidden');
            syncWarning.classList.add('hidden');
            tripodWarning.classList.add('hidden');
            allInputs.forEach(input => {
                input.classList.remove('recently-updated', 'input-warning', 'status-border-danger', 'status-border-warning');
            });
            
            lastUpdatedParam = null;
            isTyping = false;
            calculateExposure();
        }

        // 设置快门模式切换事件
        function setupShutterModeToggle() {
            shutterFractionBtn.addEventListener('click', () => toggleShutterMode('fraction'));
            shutterSecondBtn.addEventListener('click', () => toggleShutterMode('second'));
            
            // 添加键盘支持
            shutterFractionBtn.setAttribute('tabindex', '0');
            shutterSecondBtn.setAttribute('tabindex', '0');
            
            shutterFractionBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleShutterMode('fraction');
                }
            });
            
            shutterSecondBtn.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    toggleShutterMode('second');
                }
            });
        }

        // 事件监听 - 小数输入处理
        const decimalInputs = [gnInput, distanceInput, apertureInput, minApertureInput, maxApertureInput];
        
        decimalInputs.forEach(input => {
            // 输入开始时标记为正在输入
            input.addEventListener('focus', () => {
                isTyping = true;
            });
            
            // 实时输入时使用防抖处理
            input.addEventListener('input', (e) => {
                // 允许空值和带小数点的输入
                if (e.target.value === '' || e.target.value === '.') return;
                
                // 清除之前的计时器
                if (calculationDebounceTimer) {
                    clearTimeout(calculationDebounceTimer);
                }
                
                // 500ms防抖，避免频繁计算
                calculationDebounceTimer = setTimeout(() => {
                    // 只验证范围不修正格式
                    validateAndFixParams(true);
                    calculateExposure(e.target.id, true);
                }, 500);
            });
            
            // 输入完成时（失去焦点或按回车）进行完整验证和修正
            input.addEventListener('blur', (e) => {
                isTyping = false;
                // 清除防抖计时器
                if (calculationDebounceTimer) {
                    clearTimeout(calculationDebounceTimer);
                    calculationDebounceTimer = null;
                }
                calculateExposure(e.target.id);
            });
            
            input.addEventListener('keydown', (e) => {
                // 按回车键视为输入完成
                if (e.key === 'Enter') {
                    e.target.blur();
                    isTyping = false;
                    // 清除防抖计时器
                    if (calculationDebounceTimer) {
                        clearTimeout(calculationDebounceTimer);
                        calculationDebounceTimer = null;
                    }
                    calculateExposure(e.target.id);
                }
            });
        });
        
        // 整数输入处理（快门和功率、ISO）
        const integerInputs = [powerInput, isoInput, shutterInput];
        integerInputs.forEach(input => {
            input.addEventListener('input', (e) => {
                // 允许空值
                if (e.target.value === '') return;
                
                // 清除之前的计时器
                if (calculationDebounceTimer) {
                    clearTimeout(calculationDebounceTimer);
                }
                
                // 300ms防抖
                calculationDebounceTimer = setTimeout(() => {
                    calculateExposure(e.target.id);
                }, 300);
            });
            
            input.addEventListener('change', (e) => {
                // 清除防抖计时器
                if (calculationDebounceTimer) {
                    clearTimeout(calculationDebounceTimer);
                    calculationDebounceTimer = null;
                }
                calculateExposure(e.target.id);
            });
        });

        // 重置按钮
        resetBtn.addEventListener('click', resetParameters);

        // 初始化
        window.addEventListener('load', () => {
            setupShutterModeToggle();
            calculateExposure();
        });
    </script>
</body>
</html>




